# Политика безопасности

Документ описывает правила доступа, хранения данных и запрещённые действия в системе HLR Bulk Checker.

---

## 1. Роли и доступ

### Роли пользователей

| Роль | Права | Описание |
|------|-------|----------|
| **admin** | Полный доступ | Управление пользователями, просмотр всех батчей, настройки системы |
| **user** | Ограниченный | Только свои проверки, экспорт своих результатов |

### Матрица доступа

| Действие | admin | user |
|----------|-------|------|
| Проверка номеров | ✅ | ✅ |
| Просмотр своих батчей | ✅ | ✅ |
| Экспорт своих результатов | ✅ | ✅ |
| Просмотр чужих батчей | ✅ | ❌ |
| Создание пользователей | ✅ | ❌ |
| Блокировка пользователей | ✅ | ❌ |
| Изменение лимитов | ✅ | ❌ |
| Просмотр журнала действий | ✅ | ❌ |
| Доступ к балансу Seven.io | ✅ | ❌ |

---

## 2. Управление аккаунтами

### Создание аккаунтов

Аккаунты создаются **только администратором** через:
1. Админ-панель → Пользователи → Добавить
2. Прямой SQL запрос (для первого админа)

**Самостоятельная регистрация отключена.**

### Требования к паролям

| Параметр | Значение |
|----------|----------|
| Минимальная длина | 8 символов |
| Хэширование | bcrypt (cost factor 10) |
| Хранение | Только хэш, пароль не сохраняется |

### Блокировка аккаунта

Аккаунт блокируется автоматически после **5 неудачных попыток входа**. Разблокировка — только администратором.

### Удаление аккаунта

При удалении пользователя:
- Аккаунт деактивируется (soft delete)
- Данные проверок сохраняются для аудита
- Полное удаление — только через БД

---

## 3. Хранение данных

### Телефонные номера

| Где | Формат | Пример |
|----|--------|--------|
| База данных | Полный номер | +380501234567 |
| Логи приложения | Маскированный | +380***4567 |
| Экспорт CSV | Полный номер | +380501234567 |

**Рекомендация:** Настройте маскирование в логах:

```typescript
// server/phoneUtils.ts
export function maskPhone(phone: string): string {
  if (phone.length < 7) return '***';
  return phone.slice(0, 4) + '***' + phone.slice(-4);
}
```

### Результаты проверок

| Данные | Хранение | Срок |
|--------|----------|------|
| Результаты HLR | База данных | 90 дней |
| Кэш результатов | База данных | 24 часа |
| Журнал действий | База данных | 365 дней |
| Логи приложения | Файловая система | 30 дней |

### Политика ретеншена

```sql
-- Автоматическая очистка старых данных (добавить в cron)

-- Удаление результатов старше 90 дней
DELETE FROM hlr_results 
WHERE created_at < DATE_SUB(NOW(), INTERVAL 90 DAY);

-- Удаление батчей без результатов старше 90 дней
DELETE FROM hlr_batches 
WHERE created_at < DATE_SUB(NOW(), INTERVAL 90 DAY)
  AND id NOT IN (SELECT DISTINCT batch_id FROM hlr_results);

-- Удаление логов старше 365 дней
DELETE FROM action_logs 
WHERE created_at < DATE_SUB(NOW(), INTERVAL 365 DAY);
```

Cron задача для автоочистки:

```bash
0 3 * * 0 mysql -u hlr_user -p'password' hlr_checker < /path/to/cleanup.sql
```

---

## 4. Защита API

### Аутентификация

Все API эндпоинты (кроме `/api/health`) требуют JWT токен в cookie `session`.

| Параметр | Значение |
|----------|----------|
| Алгоритм | HS256 |
| Срок жизни | 7 дней |
| Обновление | При каждом запросе |
| Хранение | HttpOnly cookie |

### Rate Limiting

| Эндпоинт | Лимит | Окно |
|----------|-------|------|
| `/api/auth/login` | 5 запросов | 15 минут |
| `/api/trpc/hlr.*` | 100 запросов | 1 минута |
| Остальные | 1000 запросов | 1 минута |

### CORS

```typescript
// Разрешённые origins (настроить в production)
const allowedOrigins = [
  'https://your-domain.com',
  'https://www.your-domain.com'
];
```

---

## 5. Запрещённые действия

### Категорически запрещено

| Действие | Последствие |
|----------|-------------|
| Передача CSV с номерами третьим лицам | Блокировка аккаунта |
| Шаринг аккаунта между пользователями | Блокировка аккаунта |
| Автоматизация без согласования | Блокировка IP |
| Попытки обхода лимитов | Блокировка аккаунта |
| Использование для спама/мошенничества | Блокировка + юридические меры |

### Мониторинг нарушений

Система автоматически отслеживает:
- Аномально большое количество проверок
- Множественные входы с разных IP
- Попытки доступа к чужим данным
- Массовый экспорт результатов

---

## 6. Безопасность инфраструктуры

### Сервер

| Мера | Статус |
|------|--------|
| Firewall (ufw/iptables) | Обязательно |
| SSH только по ключу | Обязательно |
| Fail2ban | Рекомендуется |
| Автообновления безопасности | Рекомендуется |

### База данных

| Мера | Статус |
|------|--------|
| Доступ только с localhost | Обязательно |
| Отдельный пользователь для приложения | Обязательно |
| Регулярные бэкапы | Обязательно |
| Шифрование at rest | Рекомендуется |

### Приложение

| Мера | Статус |
|------|--------|
| HTTPS | Обязательно |
| Secure cookies | Обязательно |
| CSP headers | Рекомендуется |
| Регулярное обновление зависимостей | Обязательно |

---

## 7. Инцидент-менеджмент

### При обнаружении утечки данных

1. **Немедленно** заблокировать затронутые аккаунты
2. Сохранить логи для расследования
3. Уведомить администратора
4. Задокументировать инцидент
5. Провести анализ причин

### При подозрении на взлом

1. Отключить сервис от сети
2. Сохранить состояние системы (snapshot)
3. Проанализировать логи
4. Сменить все credentials
5. Восстановить из чистого бэкапа

---

## 8. Аудит

### Журналируемые события

| Событие | Данные |
|---------|--------|
| Вход в систему | user_id, IP, timestamp, успех/неудача |
| Выход из системы | user_id, timestamp |
| Создание батча | user_id, batch_id, количество номеров |
| Экспорт результатов | user_id, batch_id, формат |
| Изменение пользователя | admin_id, target_user_id, изменения |
| Ошибки авторизации | IP, username, timestamp |

### Просмотр журнала

```sql
-- Последние 100 действий
SELECT * FROM action_logs ORDER BY created_at DESC LIMIT 100;

-- Действия конкретного пользователя
SELECT * FROM action_logs WHERE user_id = <ID> ORDER BY created_at DESC;

-- Неудачные попытки входа
SELECT * FROM action_logs 
WHERE action = 'login_failed' 
  AND created_at > DATE_SUB(NOW(), INTERVAL 24 HOUR);
```

---

## 9. Соответствие требованиям

### GDPR (если применимо)

- Право на удаление: администратор может удалить все данные пользователя
- Право на экспорт: пользователь может экспортировать свои данные
- Минимизация данных: храним только необходимое

### Локальное законодательство

Убедитесь, что использование HLR lookup соответствует законодательству вашей юрисдикции о защите персональных данных и телекоммуникациях.

---

*Документ подлежит пересмотру каждые 6 месяцев.*
