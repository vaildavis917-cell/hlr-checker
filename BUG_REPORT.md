# Bug Report - HLR Checker

## Дата аудита: 2026-02-04

---

## КРИТИЧЕСКИЕ БАГИ (Исправлены)

### 1. ✅ Email permission ошибка (ИСПРАВЛЕНО)
**Файл:** `server/routers.ts` строка ~1119
**Проблема:** В `email.startBatch` проверялся permission `"hlr.batch"` вместо `"email.batch"`.
**Влияние:** Пользователи с правами только на email не могли запускать email проверки.
**Статус:** Исправлено - заменено на `"email.batch"`.

### 2. ✅ HLR rate limiting (ИСПРАВЛЕНО)
**Файл:** `server/routers.ts` строка ~2214
**Проблема:** Не было задержки между API вызовами Seven.io в batch проверке.
**Влияние:** API возвращал ошибки rate limit, проверка останавливалась на 10-15 номерах.
**Статус:** Исправлено - добавлена задержка 150ms между вызовами.

### 3. ✅ Email regex слишком строгий (ИСПРАВЛЕНО)
**Файл:** `server/routers.ts` строки ~1132, ~1552
**Проблема:** Regex отфильтровывал некоторые валидные email адреса.
**Влияние:** Часть email адресов не попадала в проверку.
**Статус:** Исправлено - regex обновлён на более гибкий.

---

## ПОТЕНЦИАЛЬНЫЕ ПРОБЛЕМЫ (Требуют внимания)

### 4. ⚠️ HLR resumeBatch не перепроверяет номера
**Файл:** `server/routers.ts` строки ~2481-2538
**Проблема:** `hlr.resumeBatch` без phoneNumbers просто помечает батч как завершённый, не перепроверяя оставшиеся номера.
**Причина:** Оригинальные номера не сохраняются в БД, поэтому невозможно узнать какие номера остались.
**Решение:** Использовать `resumeBatchWithNumbers` с передачей исходного списка номеров.
**Статус:** Работает как задумано, но UX можно улучшить.

### 5. ⚠️ Нет graceful shutdown для email батчей
**Файл:** `server/routers.ts` строки ~1172-1256
**Проблема:** Email батчи не обрабатывают `isShutdownInProgress()`, в отличие от HLR.
**Влияние:** При перезапуске сервера email батч может прерваться без возможности корректного возобновления.
**Рекомендация:** Добавить проверку shutdown в цикл обработки email.

### 6. ⚠️ Нет задержки в HLR resumeBatchWithNumbers
**Файл:** `server/routers.ts` строки ~2588-2651
**Проблема:** В `resumeBatchWithNumbers` нет задержки между API вызовами.
**Влияние:** При возобновлении большого батча может сработать rate limit.
**Рекомендация:** Добавить `await sleep(150)` как в основном startBatch.

---

## АНАЛИЗ КОДА

### Frontend - EmailValidator.tsx

**Парсинг email:**
```javascript
const emails = batchEmails
  .split(/[\n,;]/)
  .map((e) => e.trim())
  .filter((e) => e.length > 0);
```
✅ Корректно разделяет по переносам строк, запятым и точкам с запятой.

**Кнопка "Начать проверку":**
```javascript
disabled={isProcessing || !batchEmails.trim() || !batchName.trim()}
```
✅ Кнопка активна когда есть имя батча и email адреса.

**Проблема с кнопкой:** Если пользователь вводит email, но не вводит имя батча - кнопка неактивна. Это ожидаемое поведение, но может быть неочевидно пользователю.

### Frontend - Home.tsx (HLR)

**Парсинг номеров:**
```javascript
const phones = batchPhones
  .split(/[\n,;]/)
  .map((p) => p.trim())
  .filter((p) => p.length > 0);
```
✅ Корректно разделяет по переносам строк, запятым и точкам с запятой.

### Backend - routers.ts

**HLR startBatch:**
- ✅ Есть retry логика с exponential backoff
- ✅ Есть graceful shutdown
- ✅ Есть кэширование результатов
- ✅ Есть задержка между вызовами (150ms)
- ✅ Результаты сохраняются сразу после каждой проверки

**Email startBatch:**
- ✅ Есть кэширование результатов
- ✅ Есть задержка между вызовами (100ms)
- ⚠️ Нет graceful shutdown
- ✅ Результаты сохраняются сразу после каждой проверки

---

## РЕКОМЕНДАЦИИ

### Высокий приоритет:
1. Добавить graceful shutdown в email батчи
2. Добавить задержку в `resumeBatchWithNumbers`

### Средний приоритет:
3. Улучшить UX для resume - показывать сколько номеров осталось
4. Добавить индикатор прогресса с ETA

### Низкий приоритет:
5. Добавить возможность отмены батча во время обработки
6. Добавить уведомление по email/telegram о завершении батча

---

## ТЕСТИРОВАНИЕ

Для проверки исправлений рекомендуется:
1. Запустить email батч с 50+ адресами
2. Запустить HLR батч с 50+ номерами
3. Проверить что все адреса/номера обрабатываются
4. Проверить что прогресс обновляется корректно
5. Проверить resume функционал для прерванных батчей
